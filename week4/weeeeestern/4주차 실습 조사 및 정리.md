# 4ì£¼ì°¨ ì‹¤ìŠµ

í”„ë¦¬í‹°ì–´ ì—†ì´ ë°°í¬ í•˜ì§€ ëª»í•´ë„ plan í†µí•´ í™•ì¸ê¹Œì§€ë§Œ í•˜ê¸°

---

### 4ê°œì˜ ì„œë¸Œë„· ë°˜ë³µ ì¤„ì´ê¸°

**`count` (ë°˜ë³µë¬¸)** ê¸°ëŠ¥ì„ ì‚¬ìš©. "ì„œë¸Œë„·ì„ 2ê°œ ë§Œë“¤ì–´ë¼"ë¼ê³  ì‹œí‚¤ê³ , ì´ë¦„ì´ë‚˜ IP ëŒ€ì—­ë§Œ ë³€ìˆ˜ ë¦¬ìŠ¤íŠ¸(`var`)ì—ì„œ í•˜ë‚˜ì”© êº¼ë‚´ ì“°ê²Œ í•˜ë©´ ì½”ë“œê°€ 4ë¶„ì˜ 1ë¡œ ì¤„ì–´ë“­ë‹ˆë‹¤.

### íŒŒì¼ì€ ì–´ë–»ê²Œ ë¶„ë¦¬í• ê¹Œ?

Terraformì€ í´ë” ì•ˆì— ìˆëŠ” ëª¨ë“  `.tf` íŒŒì¼ì„ **í•˜ë‚˜ì˜ íŒŒì¼ì²˜ëŸ¼ í•©ì³ì„œ ì¸ì‹**í•©ë‹ˆë‹¤. 

ë”°ë¼ì„œ ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” ì‚¬ëŒì´ ë³´ê¸° ì¢‹ê²Œ ê¸°ëŠ¥ë³„ë¡œë§Œ ë‚˜ëˆ„ì—ˆë‹¤

- tf íŒŒì¼ ë¶„ë¦¬ ê¸°ì¤€
    1. êµ­ë£°
        - [main.tf](http://main.tf) : í•µì‹¬ì´ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ë‚˜ Provider ì„¤ì • (í”„ë¡œì íŠ¸ê°€ ì‘ìœ¼ë©´ ë‹¤ ë„£ê¸°ë„ í•œë‹¤)
        - [variable.tf](http://variable.tf) : ì…ë ¥ê°’ë§Œ ëª¨ì•„ë‘  (ê°’ì´ ë°”ë€” ìˆ˜ ìˆëŠ” ê²ƒë“¤)
        - [output.tf](http://output.tf) : ê²°ê³¼ê°’ë§Œ ëª¨ì•„ë‘  (ipì£¼ì†Œ, DNS ë“±)
    2. ë¦¬ì†ŒìŠ¤ ìˆ˜ëª…ì£¼ê¸°ì— ë”°ë¥¸ ë¶„ë¦¬
        - [vpc.tf](http://vpc.tf) : ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ (ë„¤íŠ¸ì›Œí¬ëŠ” í•œ ë²ˆ ë§Œë“¤ë©´ ì˜ ì•ˆë°”ê¿ˆ)
        - [ec2.tf](http://ec2.tf/) / [app.tf](http://app.tf) : ì„œë²„ëŠ” ìì£¼ ë§Œë“¤ì—ˆë‹¤ ì§€ì› ë‹¤ í•˜ê±°ë‚˜ ìŠ¤í™ì„ ìì£¼ ë³€ê²½í•¨
        - [iam.tf](http://iam.tf) : ê¶Œí•œ ê´€ë ¨ ì„¤ì •ì€ ë¯¼ê°í•˜ë‹ˆê¹Œ
    3. ìŠ¤í¬ë¡¤ 3ë²ˆ ë‚´ë ¸ëŠ”ë° ì•ˆëë‚œë‹¤? â†’ ìª¼ê°œëŠ” ê²Œ ì¢‹ìŒ 
- `variables.tf`: ë³€ìˆ˜ ì •ì˜ (ì„¤ì •ê°’ ëª¨ìŒ)
- `vpc.tf`: ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ (VPC, Subnet, IGW, NAT)
- `sg.tf`: ë³´ì•ˆ ê·¸ë£¹ (Security Group)
- `ec2.tf`: ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ (EC2, Key Pair)
- `alb.tf`: ë¡œë“œë°¸ëŸ°ì„œ (ALB)
- `outputs.tf`: ê²°ê³¼ ì¶œë ¥ (ì ‘ì† ì£¼ì†Œ ë“±)

### ì½˜ì†”ì—ì„œ ì§ì ‘ ìˆ˜ì •í•˜ë©´ Terraformì´ ì•Œê¹Œ? (Drift ê°ì§€)

ë„¤!

Terraformì€ terraform.tfstateë¼ëŠ” íŒŒì¼ì— ìì‹ ì´ ë§Œë“  ìƒíƒœë¥¼ ì €ì¥í•´ë‘¡ë‹ˆë‹¤.

ë§Œì•½ ë‚´ê°€ AWS ì½˜ì†”ì—ì„œ ëª°ë˜ ë³´ì•ˆ ê·¸ë£¹ í¬íŠ¸ë¥¼ ì—´ì–´ë‘ë©´?

- ë‹¤ìŒì— `terraform plan`ì„ ì³¤ì„ ë•Œ: **"ì–´? ì½”ë“œëŠ” ë‹«í˜€ ìˆëŠ”ë° ì‹¤ì œë¡œëŠ” ì—´ë ¤ ìˆë„¤? ë‹¤ì‹œ ë‹«ê² ìŠµë‹ˆë‹¤."** ë¼ê³  ì›ìƒë³µêµ¬(Revert) í•˜ë ¤ëŠ” ê³„íšì„ ì„¸ì›ë‹ˆë‹¤.
- ì´ê²ƒì„ **Configuration Drift(êµ¬ì„± í¸ì°¨)**ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤. 
(ê·¸ë˜ì„œ í…Œë¼í¼ ì“¸ ë• ì½˜ì†” ì†ëŒ€ì§€ ì•ŠëŠ” ê²Œ êµ­ë£°)

---

### 2. Terraform ì½”ë“œ (Chapter 1 + Chapter 2)

![image.png](image.png)

![image.png](image%201.png)

### 1) `variables.tf` (ì„¤ì •ê°’ ê´€ë¦¬)

IP ëŒ€ì—­ì´ë‚˜ ê°€ìš© ì˜ì—­ì„ ì—¬ê¸°ì„œ í•œ ë²ˆì— ê´€ë¦¬

ë‚˜ì¤‘ì—  ë°”ê¿€ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ê°’ë“¤

```c
variable "region" {
  default = "ap-northeast-2"
}

variable "vpc_cidr" 
  default = "10.0.0.0/16"
}

# ê³µì¸ ì„œë¸Œë„· 2ê°œ ëŒ€ì—­
variable "public_subnet_cidrs" {
  type    = list(string)
  default = ["10.0.1.0/24", "10.0.2.0/24"]
}

# ì‚¬ì„¤ ì„œë¸Œë„· 2ê°œ ëŒ€ì—­
variable "private_subnet_cidrs" {
  type    = list(string)
  default = ["10.0.10.0/24", "10.0.20.0/24"]
}

# ê°€ìš© ì˜ì—­ (2ê°œ ì‚¬ìš©)
variable "azs" {
  type    = list(string)
  default = ["ap-northeast-2a", "ap-northeast-2c"]
}
```

### 2) `vpc.tf` (ë„¤íŠ¸ì›Œí¬ - ë°˜ë³µë¬¸ ì ìš©ë¨) â­

`count`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¸Œë„· ì½”ë“œë¥¼ ë°˜ë³µì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.

VPC, subnet 4ê°œ, IGW, NAT(ì‚¬ì„¤ ì„œë¸Œë„· ì¸í„°ë„· ì•„ì›ƒë°”ìš´ë“œ)

```c
provider "aws" {
  region = var.region
}

# 1. VPC
resource "aws_vpc" "main" {
  cidr_block           = var.vpc_cidr
  enable_dns_hostnames = true
  tags = { Name = "my-terraform-vpc" }
}

# 2. Public Subnets (2ê°œ ìë™ ìƒì„±)
resource "aws_subnet" "public" {
  count             = length(var.public_subnet_cidrs) # ë¦¬ìŠ¤íŠ¸ ê°œìˆ˜ë§Œí¼ ë°˜ë³µ(2ë²ˆ)

  vpc_id            = aws_vpc.main.id
  cidr_block        = var.public_subnet_cidrs[**count**.index]
  availability_zone = var.azs[**count**.index] # aì¡´, cì¡´ ìˆœì„œëŒ€ë¡œ í• ë‹¹
  map_public_ip_on_launch = true

  tags = { Name = "public-subnet-${count.index + 1}" }
}

# 3. Private Subnets (2ê°œ ìë™ ìƒì„±)
resource "aws_subnet" "private" {
  count             = length(var.private_subnet_cidrs)

  vpc_id            = aws_vpc.main.id
  cidr_block        = var.private_subnet_cidrs[**count**.index]
  availability_zone = var.azs[**count**.index]

  tags = { Name = "private-subnet-${count.index + 1}" }
}

# 4. IGW
resource "aws_internet_gateway" "igw" {
  vpc_id = aws_vpc.main.id
  tags = { Name = "my-igw" }
}

# 5. NAT Gateway (ë¹„ìš© ì ˆì•½ì„ ìœ„í•´ ì²« ë²ˆì§¸ Public Subnetì— 1ê°œë§Œ ìƒì„±)
resource "aws_eip" "nat" {
  domain = "vpc"
}

resource "aws_nat_gateway" "nat_gw" {
  allocation_id = aws_eip.nat.id
  subnet_id     = aws_subnet.public[0].id # ì²« ë²ˆì§¸([0]) ê³µì¸ ì„œë¸Œë„·ì— ìœ„ì¹˜
  depends_on    = [aws_internet_gateway.igw]
  tags = { Name = "my-nat-gw" }
}

# 6. Route Tables
resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id
  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.igw.id
  }
  tags = { Name = "public-rt" }
}

resource "aws_route_table" "private" {
  vpc_id = aws_vpc.main.id
  route {
    cidr_block     = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.nat_gw.id
  }
  tags = { Name = "private-rt" }
}

# 7. Route Table Association (ë°˜ë³µë¬¸ìœ¼ë¡œ ì—°ê²°)
resource "aws_route_table_association" "public" {
  count          = length(var.public_subnet_cidrs)
  subnet_id      = aws_subnet.public[count.index].id
  route_table_id = aws_route_table.public.id
}

resource "aws_route_table_association" "private" {
  count          = length(var.private_subnet_cidrs)
  subnet_id      = aws_subnet.private[count.index].id
  route_table_id = aws_route_table.private.id
}
```

### 3) `sg.tf` (ë³´ì•ˆ ê·¸ë£¹)

bastion, ALB, WEB (0.0.0.0 ì—ì„œ ì˜¤ëŠ” ì ‘ì† ë‹¤ ì°¨ë‹¨, albë‘ ë°°ì…˜ì—ì„œ ì˜¤ëŠ” ê²ƒë§Œ ë°›ë„ë¡)

```c
resource "aws_security_group" "bastion" {
  name   = "sg_bastion"
  vpc_id = aws_vpc.main.id

  ingress {
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
  tags = { Name = "sg-bastion" }
}

resource "aws_security_group" "alb" {
  name   = "sg_alb"
  vpc_id = aws_vpc.main.id

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
  tags = { Name = "sg-alb" }
}

resource "aws_security_group" "web" {
  name   = "sg_web"
  vpc_id = aws_vpc.main.id

  ingress {
    from_port       = 22
    to_port         = 22
    protocol        = "tcp"
    security_groups = [aws_security_group.bastion.id]
  }
  ingress {
    from_port       = 80
    to_port         = 80
    protocol        = "tcp"
    security_groups = [aws_security_group.alb.id]
  }
  egress {
    from_port   = 
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
  tags = { Name = "sg-web" }
}
```

### 4) `ec2.tf` (ì„œë²„ ë° í‚¤ í˜ì–´)

ami (ì´ë¯¸ì§€ ë²ˆí˜¸ í™•ì¸í•´ì„œ ìµœì„ ë²„ì „ ê°€ì ¸ì˜¤ê¸°)

í…Œë¼í¼ì´ í‚¤ë¥¼ ë§Œë“¤ê³  ë¡œì»¬ì— pem íŒŒì¼ ì €ì¥í•˜ëŠ” ë°©ì‹

web â†’ ì—…ë°ì´íŠ¸í•˜ê³ , ì–´íŒŒì¹˜ ë‚„ê³ , ê°„ë‹¨í•œ í™ˆí˜ì´ì§€(html) í•˜ë‚˜ ë§Œë“¤ì–´ ë†“ê¸°

```c
data "aws_ami" "amazon_linux_2023" {
  most_recent = true
  owners      = ["amazon"]
  filter {
    name   = "name"
    values = ["al2023-ami-2023.*-x86_64"]
  }
}

resource "tls_private_key" "pk" {
  algorithm = "RSA"
  rsa_bits  = 4096
}

resource "aws_key_pair" "kp" {
  key_name   = "my-terraform-key"
  public_key = tls_private_key.pk.public_key_openssh
}

resource "local_file" "pem" {
  filename        = "${path.module}/my-terraform-key.pem"
  content         = tls_private_key.pk.private_key_pem
  file_permission = "0400"
}

# Bastion (ì²« ë²ˆì§¸ Public Subnetì— ìƒì„±)
resource "aws_instance" "bastion" {
  ami                    = data.aws_ami.amazon_linux_2023.id
  instance_type          = "t2.micro"
  subnet_id              = aws_subnet.public[0].id
  key_name               = aws_key_pair.kp.key_name
  vpc_security_group_ids = [aws_security_group.bastion.id]

  tags = { Name = "Bastion-Host" }
}

# Web Server (ì²« ë²ˆì§¸ Private Subnetì— ìƒì„±)
resource "aws_instance" "web" {
  ami                    = data.aws_ami.amazon_linux_2023.id
  instance_type          = "t2.micro"
  subnet_id              = aws_subnet.private[0].id
  key_name               = aws_key_pair.kp.key_name
  vpc_security_group_ids = [aws_security_group.web.id]

  user_data = <<-EOF
              #!/bin/bash
              yum update -y
              yum install -y httpd
              systemctl start httpd
              systemctl enable httpd
              echo "<h1>Hello from Split File Terraform!</h1>" > /var/www/html/index.html
              EOF

  tags = { Name = "Web-Server" }
}
```

### 5) `alb.tf` (ë¡œë“œë°¸ëŸ°ì„œ)

ì—¬ê¸°ì„œ `subnets = aws_subnet.public[*].id` êµ¬ë¬¸ì´ ì¤‘ìš”

ì•„ê¹Œ [vpc.tf](http://vpc.tf) ì—ì„œ ë°˜ë³µë¬¸ìœ¼ë¡œ ë§Œë“  ëª¨ë“  Public Subnetì„ ë¦¬ìŠ¤íŠ¸ë¡œ í•œ ë²ˆì— ê°€ì ¸ì˜¤ëŠ” ë¬¸ë²•

```c
resource "aws_lb" "main" {
  name               = "my-alb"
  internal           = false
  load_balancer_type = "application"
  security_groups    = [aws_security_group.alb.id]
  subnets            = aws_subnet.public[*].id # [*]ëŠ” 'ëª¨ë‘'ë¼ëŠ” ëœ»

  tags = { Name = "my-alb" }
}

resource "aws_lb_target_group" "web" {
  name     = "my-web-tg"
  port     = 80
  protocol = "HTTP"
  vpc_id   = aws_vpc.main.id
}

resource "aws_lb_target_group_attachment" "web" {
  target_group_arn = aws_lb_target_group.web.arn
  target_id        = aws_instance.web.id
  port             = 80
}

resource "aws_lb_listener" "front_end" {
  load_balancer_arn = aws_lb.main.arn
  port              = "80"
  protocol          = "HTTP"

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.web.arn
  }
}
```

### 6) `outputs.tf` (ê²°ê³¼ í™•ì¸)

ê²°ê³¼ê°’ë“¤.. apply ëë‚˜ê³  ê²°ê³¼

```c
output "alb_dns_name" {
  description = "ë¡œë“œë°¸ëŸ°ì„œ ì ‘ì† ì£¼ì†Œ"
  value       = "http://${aws_lb.main.dns_name}"
}
```

---

ì´ë²ˆì— ì„œë¸Œë„·ì´ ì—¬ëŸ¬ê°œë‹ˆê¹Œ ì„œë¸Œë„· ë°˜ë³µì„ ì¤„ì´ê¸° ìœ„í•´ ë°˜ë³µë¬¸ countë¥¼ ì‚¬ìš©í–ˆì—ˆë‹¤.

### `count` vs `for_each`

count ì“¸ ë•Œ ì¡°ì‹¬í•´ì•¼ í•  ìƒí™©

- **ìƒí™©:** ë¦¬ìŠ¤íŠ¸ê°€ `["A", "B", "C"]` ì˜€ëŠ”ë°, ë§¨ ì•ì˜ **"A"ë¥¼ ì§€ìš°ê³ ** `["B", "C"]`ë¡œ ë§Œë“¤ìŒ

Terraformì€ ì´ ë•Œ 1ë²ˆì´ Bê°€ ëìœ¼ë¯€ë¡œ, Aë¥¼ ì‚­ì œí•˜ê³  Bë¥¼ ìƒì„±í•¨

                           2ë²ˆì´ Cê°€ ëìœ¼ë¯€ë¡œ, Bë¥¼ ì‚­ì œí•˜ê³  Cë¥¼ ìƒì„±í•¨ 

                           3ë²ˆì´ ì—†ì–´ì¡Œìœ¼ë¯€ë¡œ, Cë¥¼ ì‚­ì œí•¨

â‡’ ê·¸ëƒ¥ Aë§Œ ì§€ìš°ë©´ ë˜ëŠ”ë° ë©€ì©¡í•œ Bë‘ Cê¹Œì§€ ë‹¤ íŒŒê´´í•˜ê³  ë‹¤ì‹œ ë§Œë“¤ì–´ë²„ë¦°ë‹¤

<aside>
ğŸ’¡

ì´ë•Œ ë¦¬ìŠ¤íŠ¸ì˜ ìˆœì„œ(index)ê°€ ì•„ë‹ˆë¼ ê³ ìœ í•œ ì´ë¦„(key)ë¡œ ê´€ë¦¬í•˜ëŠ” `for_each` êµ¬ë¬¸ì„ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤.

</aside>

ì§€ê¸ˆì€ ì‹¤ìŠµì´ì—¬ì„œ terraform.tfstate íŒŒì¼ì´ ë¡œì»¬ì— ìƒê¸°ê² ì§€ë§Œ, íŒ€í”„ë¡œì íŠ¸ë¼ë©´?

### `terraform.tfstate` íŒŒì¼ì€ ì–´ë””ì— ë‘¬ì•¼ í• ê¹Œ? (Remote State)

íŒ€ í”„ë¡œì íŠ¸ì—ì„œ ìƒíƒœíŒŒì¼ì„ ë¡œì»¬ì— ë‘”ë‹¤ë©´ ì ˆëŒ€ ì•ˆ ë ê²ƒì´ë‹¤..

<aside>
ğŸ’¡

Remote Backend ë¥¼ ì‚¬ìš©í•˜ì ex. AWS S3 

</aside>

ë§Œì•½ ë‚˜ë‘ ë‚´ íŒ€ì›ì´ ë™ì‹œì— `terraform apply`ë¥¼ ì‹¤í–‰í•œë‹¤ë©´? 

### ìƒíƒœ ì ê¸ˆ (State Locking)

ìƒíƒœíŒŒì¼ì´ ê¼¬ì´ê²Œ ë  ê²ƒ ê°™ë‹¤.

<aside>
ğŸ’¡

ìˆ˜ì • ì¤‘ì¼ ë•ŒëŠ” ë¹ ë¥´ê³  ì €ë ´í•œ **DynamoDB** ê°™ì€ ê²ƒì„ ì´ìš©í•´ "ì‚¬ìš© ì¤‘" ì ê¸ˆ(Lock)ì„ ê±¸ë„ë¡ í•˜ì

</aside>

ì²˜ìŒ [main.tf](http://main.tf) ê°™ì€ ê³³ì— ì´ë ‡ê²Œ ë½ ì„¤ì •

```c
terraform {
  backend "s3" {
    bucket         = "ë‚´-ì†Œì¤‘í•œ-ì¥ë¶€-ì €ì¥ì†Œ"
    key            = "terraform.tfstate"
    region         = "ap-northeast-2"
    
    **dynamodb_table = "terraform-lock-table"** 
  }
}
```

ì´ ì½”ë“œë¡œ terraform init í›„, ê·¸ ë’¤ë¶€í„°ëŠ” terraform applyë¥¼ ì¹  ë•Œë§ˆë‹¤ í…Œë¼í¼ì´ ìë™ìœ¼ë¡œ í•´ë‹¹ ëª…ë ¹ì–´ ì‹¤í–‰ ì „ì— dynamoì—ì„œ ë½ì„ ê±¸ê³  ëª…ë ¹ì–´ ì‘ì—…ì„ ì‹œì‘í•œë‹¤ê³  í•œë‹¤. ì‘ì—… ëë‚˜ë©´ ìë™ìœ¼ë¡œ ë½ í•´ì œí•˜ê³ ,,,

---

ì‹¤ìŠµ ëë‚˜ê³  ì§ì ‘ ë­ í•´ë³´ê¸° ??! ë„ ë‚˜ì¤‘ì— í•˜ë‚˜ì—¬? (ex. ë‚´ ì„œë¹„ìŠ¤ terraform ìœ¼ë¡œ ì˜®ê²¨ë³´ê¸°)