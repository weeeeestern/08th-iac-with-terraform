# 주제

Terraform Configuration Drift

# 요약

- 의미: 실제 인프라 상태가 Terraform 설정 파일 및 상태 파일(terraform.tfstate)에 정의된 의도된 상태와 달라지는 현상.
- 주요 원인: 수동 변경, 외부 자동화, 또는 긴급 수정 시 Terraform 워크플로우를 우회 등.
- 드리프트는 인프라의 예측 불가능성과 일관성 상실을 초래하며, `terraform plan`/`apply` 명령을 통해 감지 및 해결 가능.


# 학습 내용

## Configuration Drift의 정의와 발생 원인

* 정의: 실제 인프라 리소스의 상태 (클라우드 환경에 존재하는 모습)가 Terraform의 Configuration (설정 파일)과 State File (terraform.tfstate)에 기록된 의도된 상태와 불일치하는 현상.
* 발생 원인:
    1. 수동 변경 (Manual Changes): 클라우드 콘솔, CLI 등을 통해 Terraform을 사용하지 않고 리소스를 직접 변경하는 경우 (가장 흔한 원인)
    2. 외부 자동화 도구: Terraform 외의 다른 구성 관리 또는 자동화 도구가 해당 리소스를 변경하는 경우
    3. 클라우드 공급자 내부 변경: 리소스의 자동 복구 메커니즘 등으로 인해 Terraform 외부에서 상태가 변경된 경우.


## 드리프트의 위험성과 영향

* 예측 불가능성: 드리프트 상태에서 `terraform apply`를 실행하면, Terraform이 의도된 상태로 되돌리기 위해 예상치 못한 변경 (예: 리소스 파괴 후 재 생성)을 수행할 수 있음
* 일관성 상실: Terraform 코드가 더 이상 인프라의 "단일 진실 공급원(Single Source of Truth)" 역할을 하지 못하게 되어, 코드와 실제 운영 환경 간의 격차가 발생
* 운영 위험 증가: 수동 변경된 부분이 보안 정책이나 규정 준수를 위반할 위험이 있으며, 문제 발생 시 원인 파악을 어렵게 함


## 감지 및 해결

* 감지 방법: `terraform plan`
    * 상태 파일과 실제 인프라 상태를 비교하여 차이점(드리프트)을 식별하고, 이 차이를 해소하기 위해 필요한 작업(추가, 변경, 삭제)을 미리 보여줌.
* 해결 방법:
    1. 실제 인프라를 코드에 맞추기: `terraform apply`를 실행하여 드리프트를 해소하고 인프라를 설정 파일의 의도된 상태로 되돌림. (주로 사용하는 방법)
    2. 코드를 실제 인프라에 맞추기: 수동 변경이 의도된 경우, Terraform 설정 코드(*.tf 파일)를 수정하여 실제 인프라의 상태를 반영하도록 업데이트함.
    3. 상태 파일 업데이트: `terraform plan -refresh-only`를 사용하여 실제 인프라 상태로 상태 파일만 업데이트 (드리프트를 해소하는 근본적인 방법은 X)


# 추가

## Terraform Cloud
> 지속적인 드리프트 감지기능 제공

### 주요기능
* 정기적인 백그라운드 확인: 설정된 주기에 따라 실제 인프라 환경에 대해 자동으로 리프레시 및 플랜(Refresh & Plan) 작업을 실행하여 상태 파일과 실제 클라우드 리소스의 라이브 상태를 비교함.
* 자동 알림 및 보고: 드리프트 감지 시 관리자에게 이메일 알림이나 대시보드 알림을 즉시 전송하며, 보고서에는 드리프트가 발생한 리소스와 필요한 변경 사항이 포함됨.
* 수정 자동화 또는 수동 승인: 감지된 드리프트를 해소하기 위해 자동 수정 워크플로우를 구성하거나, 수동으로 `Apply`를 승인하도록 설정할 수 있음.